<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CGAlpha Learning</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        
        h1 {
            color: #00d4aa;
            font-size: 1.5rem;
        }
        
        .help-btn {
            background: #333;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .help-btn:hover {
            background: #444;
        }
        
        /* HITO ACTUAL */
        .hito-card {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #00d4aa;
        }
        
        .hito-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }
        
        .hito-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            background: #333;
        }
        
        .hito-status.pendiente {
            background: #f39c12;
            color: #000;
        }
        
        .hito-status.completado {
            background: #27ae60;
            color: #fff;
        }
        
        /* PROBLEMAS */
        .problemas-card {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .problemas-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #00d4aa;
        }
        
        .problema {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 3px solid;
        }
        
        .problema.python { border-color: #3498db; }
        .problema.math { border-color: #9b59b6; }
        .problema.trading { border-color: #e74c3c; }
        .problema.architect { border-color: #f39c12; }
        
        .problema-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .problema-icon {
            font-size: 1.2rem;
            margin-right: 10px;
        }
        
        .problema-agent {
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .problema.python .problema-agent { color: #3498db; }
        .problema.math .problema-agent { color: #9b59b6; }
        .problema.trading .problema-agent { color: #e74c3c; }
        .problema.architect .problema-agent { color: #f39c12; }
        
        .problema-text {
            color: #ccc;
            font-style: italic;
        }
        
        /* ACCIONES */
        .acciones-card {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .acciones-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #00d4aa;
        }
        
        .acciones-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .accion-btn {
            background: #1a1a2e;
            color: #fff;
            border: 1px solid #333;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .accion-btn:hover {
            background: #00d4aa;
            color: #000;
            border-color: #00d4aa;
        }
        
        .accion-btn.primary {
            background: #00d4aa;
            color: #000;
            border-color: #00d4aa;
        }
        
        .accion-btn.primary:hover {
            background: #00b894;
        }

        .accion-btn.small {
            padding: 8px 10px;
            font-size: 12px;
        }

        .accion-btn.danger {
            background: #7f1d1d;
            border-color: #991b1b;
            color: #fff;
        }

        .accion-btn.danger:hover {
            background: #991b1b;
            color: #fff;
            border-color: #b91c1c;
        }
        
        /* PROGRESO */
        .progreso-card {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .progreso-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #00d4aa;
        }
        
        .progreso-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        .progreso-item {
            text-align: center;
        }
        
        .progreso-label {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 5px;
        }
        
        .progreso-bar {
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .progreso-fill {
            height: 100%;
            border-radius: 4px;
        }
        
        .progreso-fill.python { background: #3498db; }
        .progreso-fill.math { background: #9b59b6; }
        .progreso-fill.trading { background: #e74c3c; }
        .progreso-fill.architect { background: #f39c12; }
        
        .progreso-pct {
            font-size: 0.85rem;
            color: #ccc;
        }
        
        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 50px 20px;
        }

        .modal.active.modal-fullscreen {
            align-items: stretch;
            padding: 0;
        }
        
        .modal-content {
            background: #16213e;
            border-radius: 10px;
            padding: 30px;
            max-width: 700px;
            width: 100%;
            position: relative;
        }

        .modal-content.fullscreen {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            width: auto;
            max-width: none;
            height: auto;
            max-height: none;
            margin: 0;
            border-radius: 0;
            padding: clamp(12px, 2vw, 22px);
            display: flex;
            flex-direction: column;
        }

        .modal-content.fullscreen .modal-title {
            padding-right: 80px;
            flex: 0 0 auto;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
        }

        .modal-fullscreen {
            position: absolute;
            top: 15px;
            right: 52px;
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
        }
        
        .modal-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #00d4aa;
        }
        
        .modal-body {
            line-height: 1.6;
        }

        .modal-content.fullscreen .modal-body {
            flex: 1 1 auto;
            min-height: 0;
            max-height: none;
            overflow-y: auto;
            padding-right: 6px;
        }
        
        .modal-body h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #00d4aa;
        }
        
        .modal-body ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .modal-body li {
            margin-bottom: 8px;
        }
        
        .modal-body code {
            background: #1a1a2e;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .modal-body pre {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
        }
        
        /* TEXTAREAS */
        .textarea-container {
            margin: 15px 0;
        }
        
        .textarea-label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
        }
        
        .textarea-input {
            width: 100%;
            min-height: 200px;
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            color: #fff;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
        }
        
        .textarea-input:focus {
            outline: none;
            border-color: #00d4aa;
        }
        
        /* ESTUDIOS */
        .estudio-content {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .modal-content.fullscreen .estudio-content {
            max-height: none;
            height: 100%;
            margin: 0;
        }
        
        .estudio-content h2 {
            color: #00d4aa;
            margin-bottom: 15px;
        }
        
        .estudio-content h3 {
            color: #3498db;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .estudio-content pre {
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            color: #cfe8ff;
            border: 1px solid #26476d;
        }

        .estudio-content code.code-view {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 13px;
            line-height: 1.45;
            white-space: pre;
            display: block;
        }

        .estudio-content .tok-keyword { color: #c792ea; }
        .estudio-content .tok-string { color: #ecc48d; }
        .estudio-content .tok-comment { color: #7f8c98; font-style: italic; }
        .estudio-content .tok-number { color: #f78c6c; }
        .estudio-content .tok-identifier { color: #82aaff; }
        .estudio-content .tok-operator { color: #89ddff; }
        .estudio-content .tok-function { color: #7dd3fc; }
        .estudio-content .tok-type { color: #4ade80; }
        .estudio-content .tok-decorator { color: #f472b6; }

        .bracket {
            font-weight: 700;
            text-shadow: 0 0 4px rgba(0,0,0,0.55);
            border-radius: 3px;
            padding: 0 1px;
        }

        .bracket-depth-0 { color: #38bdf8; }
        .bracket-depth-1 { color: #4ade80; }
        .bracket-depth-2 { color: #facc15; }
        .bracket-depth-3 { color: #f472b6; }
        .bracket-depth-4 { color: #a78bfa; }
        .bracket-depth-5 { color: #fb7185; }
        .bracket-depth-6 { color: #22d3ee; }
        .bracket-depth-7 { color: #bef264; }

        .bracket-type-round { background: transparent; border-bottom: none; }
        .bracket-type-square { background: transparent; border-bottom: none; }
        .bracket-type-curly { background: transparent; border-bottom: none; }
        .bracket-type-angle { background: transparent; border-bottom: none; }

        .bracket-mismatch {
            color: #ef4444 !important;
            background: rgba(127, 29, 29, 0.45);
            border-radius: 2px;
            padding: 0 1px;
        }

        .md-paragraph {
            margin: 10px 0;
        }

        /* FILE MANAGER */
        .file-tools {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .file-tools input,
        .file-tools select {
            width: 100%;
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px;
            color: #fff;
        }

        .file-tools .full {
            grid-column: 1 / -1;
        }

        .file-status {
            font-size: 12px;
            color: #aaa;
        }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 420px;
            overflow-y: auto;
        }

        .file-item {
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px;
        }

        .file-item-header {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
        }

        .file-name {
            font-family: monospace;
            font-size: 13px;
            word-break: break-all;
        }

        .file-meta {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 8px;
        }

        .file-preview {
            font-size: 13px;
            color: #ddd;
            margin-bottom: 10px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .file-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .file-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }

        .file-badge.class { background: #334155; color: #e2e8f0; }
        .file-badge.python { background: #1e3a8a; color: #bfdbfe; }
        .file-badge.math { background: #581c87; color: #e9d5ff; }
        .file-badge.trading { background: #7f1d1d; color: #fecaca; }
        .file-badge.architect { background: #78350f; color: #fde68a; }
        
        /* NOTIFICACIÓN */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27ae60;
            color: #fff;
            padding: 15px 25px;
            border-radius: 8px;
            display: none;
            z-index: 1001;
        }
        
        .notification.show {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* RESPONSIVE */
        @media (max-width: 600px) {
            .acciones-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .progreso-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .file-tools {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <header>
            <h1>CGAlpha Learning</h1>
            <button class="help-btn" onclick="showHelp()">? HELP</button>
        </header>
        
        <!-- HITO ACTUAL -->
        <div class="hito-card">
            <div class="hito-title">
                HITO ACTUAL: <span id="hito-nombre">Enum</span> (Día <span id="hito-dia">1</span>)
            </div>
            <span class="hito-status pendiente" id="hito-status">Pendiente</span>
        </div>
        
        <!-- PROBLEMAS -->
        <div class="problemas-card">
            <div class="problemas-title">4 PROBLEMAS DEL HITO:</div>
            
            <div class="problema python">
                <div class="problema-header">
                    <span class="problema-icon">snake</span>
                    <span class="problema-agent">PYTHON_TUTOR:</span>
                </div>
                <div class="problema-text">"¿Qué es Enum y cómo se declara en Python?"</div>
            </div>
            
            <div class="problema math">
                <div class="problema-header">
                    <span class="problema-icon">triangle</span>
                    <span class="problema-agent">MATH_TUTOR:</span>
                </div>
                <div class="problema-text">"¿Cómo se relaciona Enum con conjuntos en matemáticas?"</div>
            </div>
            
            <div class="problema trading">
                <div class="problema-header">
                    <span class="problema-icon">chart</span>
                    <span class="problema-agent">TRADING_EXPERT:</span>
                </div>
                <div class="problema-text">"¿Por qué usar Enum para LONG/SHORT en lugar de strings?"</div>
            </div>
            
            <div class="problema architect">
                <div class="problema-header">
                    <span class="problema-icon">building</span>
                    <span class="problema-agent">ARCHITECT:</span>
                </div>
                <div class="problema-text">"¿Dónde debe vivir SignalDirection en la arquitectura?"</div>
            </div>
        </div>
        
        <!-- ACCIONES -->
        <div class="acciones-card">
            <div class="acciones-title">ACCIONES:</div>
            <div class="acciones-grid">
                <button class="accion-btn primary" onclick="crearClase()">1. CREAR CLASE</button>
                <button class="accion-btn" onclick="incluirMD()">2. INCLUIR .MD</button>
                <button class="accion-btn" onclick="leerClase()">3. LEER CLASE</button>
                <button class="accion-btn" onclick="anadirExtra()">4. AÑADIR EXTRA</button>
                <button class="accion-btn" onclick="completarHito()">5. COMPLETAR</button>
                <button class="accion-btn" onclick="verHistorial()">6. HISTORIAL</button>
                <button class="accion-btn" onclick="gestionarArchivos()">7. ARCHIVOS</button>
            </div>
        </div>
        
        <!-- PROGRESO -->
        <div class="progreso-card">
            <div class="progreso-title">PROGRESO POR AGENTE:</div>
            <div class="progreso-grid">
                <div class="progreso-item">
                    <div class="progreso-label">PYTHON</div>
                    <div class="progreso-bar">
                        <div class="progreso-fill python" style="width: 0%"></div>
                    </div>
                    <div class="progreso-pct">0%</div>
                </div>
                <div class="progreso-item">
                    <div class="progreso-label">MATH</div>
                    <div class="progreso-bar">
                        <div class="progreso-fill math" style="width: 0%"></div>
                    </div>
                    <div class="progreso-pct">0%</div>
                </div>
                <div class="progreso-item">
                    <div class="progreso-label">TRADING</div>
                    <div class="progreso-bar">
                        <div class="progreso-fill trading" style="width: 0%"></div>
                    </div>
                    <div class="progreso-pct">0%</div>
                </div>
                <div class="progreso-item">
                    <div class="progreso-label">ARCHITECT</div>
                    <div class="progreso-bar">
                        <div class="progreso-fill architect" style="width: 0%"></div>
                    </div>
                    <div class="progreso-pct">0%</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">×</button>
            <button class="modal-fullscreen" id="modal-fullscreen-btn" onclick="toggleModalFullscreen()" title="Pantalla completa">⛶</button>
            <div class="modal-title" id="modal-title">Título</div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>
    
    <!-- NOTIFICACIÓN -->
    <div class="notification" id="notification"></div>

    <script src="https://unpkg.com/prettier@3.3.3/standalone.js"></script>
    <script src="https://unpkg.com/prettier@3.3.3/plugins/babel.js"></script>
    <script src="https://unpkg.com/prettier@3.3.3/plugins/estree.js"></script>
    <script src="https://unpkg.com/prettier@3.3.3/plugins/html.js"></script>
    <script src="https://unpkg.com/prettier@3.3.3/plugins/markdown.js"></script>
    <script src="https://unpkg.com/prettier@3.3.3/plugins/postcss.js"></script>
    <script src="https://unpkg.com/prettier@3.3.3/plugins/typescript.js"></script>
    <script src="https://unpkg.com/prettier@3.3.3/plugins/yaml.js"></script>

    <script>
        const EXTRA_CATEGORIES = ['PYTHON_TUTOR', 'MATH_TUTOR', 'TRADING_EXPERT', 'ARCHITECT'];
        const STORAGE_KEYS = {
            state: 'learning_state_v2',
            classes: 'learning_classes_v2',
            extras: 'learning_extras_v2',
            history: 'learning_history_v2',
            readerSettings: 'learning_reader_settings_v1',
        };
        const HITOS = ['Enum', '@dataclass', 'frozen=True', '__post_init__', 'NewType'];

        let estado = {
            hitoActual: 'Enum',
            dia: 1,
            semana: 1,
            estado: 'pendiente',
            progreso: { python: 0, math: 0, trading: 0, architect: 0 },
        };
        let classRecords = [];
        let extraRecords = [];
        let fsRootHandle = null;
        let readerSettings = {
            prettierOnRead: true,
        };

        const promptCrearClase = `Lee los siguientes archivos de la carpeta learning/:
1. PROMPT_INICIAL.md - Instrucciones para ti
2. RUTA.md - Plan de aprendizaje
3. PROGRESS.md - Estado actual del estudiante
4. HISTORY.md - Resumen de lo ya aprendido
5. guiones/python_tutor.md - Guión para Python
6. guiones/math_tutor.md - Guión para Matemáticas
7. guiones/trading_expert.md - Guión para Trading
8. guiones/architect.md - Guión para Arquitectura

Genera una clase completa para el hito actual siguiendo las instrucciones de PROMPT_INICIAL.md.
Guarda el resultado como markdown para que el estudiante lo pueda copiar.`;

        function nowDate() {
            return new Date().toISOString().split('T')[0];
        }

        function nowIso() {
            return new Date().toISOString();
        }

        function makeId(prefix) {
            return `${prefix}_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
        }

        function slugify(input) {
            return String(input || '')
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-zA-Z0-9]+/g, '_')
                .replace(/^_+|_+$/g, '')
                .toLowerCase() || 'item';
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function applyInlineMarkdown(line) {
            let out = escapeHtml(line);
            out = out.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            out = out.replace(/(^|[^*])\*([^*]+)\*/g, '$1<em>$2</em>');
            out = out.replace(/`([^`]+)`/g, '<code>$1</code>');
            return out;
        }

        function markdownToHtml(md) {
            const normalized = String(md || '').replace(/\r\n/g, '\n');
            const codeBlocks = [];
            let text = normalized.replace(/```([^\n`]*)\n([\s\S]*?)```/g, (_m, lang, code) => {
                const idx = codeBlocks.push({
                    lang: String(lang || '').trim().toLowerCase(),
                    code,
                }) - 1;
                return `@@CODEBLOCK_${idx}@@`;
            });

            const lines = text.split('\n');
            const out = [];
            let inUl = false;
            let inOl = false;
            let paragraph = [];

            function flushParagraph() {
                if (paragraph.length > 0) {
                    out.push(`<p class="md-paragraph">${applyInlineMarkdown(paragraph.join(' '))}</p>`);
                    paragraph = [];
                }
            }

            function closeLists() {
                if (inUl) {
                    out.push('</ul>');
                    inUl = false;
                }
                if (inOl) {
                    out.push('</ol>');
                    inOl = false;
                }
            }

            for (const rawLine of lines) {
                const line = rawLine.trimEnd();
                const trimmed = line.trim();

                if (!trimmed) {
                    flushParagraph();
                    closeLists();
                    continue;
                }

                const codeMatch = trimmed.match(/^@@CODEBLOCK_(\d+)@@$/);
                if (codeMatch) {
                    flushParagraph();
                    closeLists();
                    const block = codeBlocks[Number(codeMatch[1])] || { lang: '', code: '' };
                    const langClass = block.lang ? ` language-${escapeHtml(block.lang)}` : '';
                    out.push(`<pre><code class="code-view${langClass}">${escapeHtml(block.code)}</code></pre>`);
                    continue;
                }

                const h3 = trimmed.match(/^###\s+(.*)$/);
                if (h3) {
                    flushParagraph();
                    closeLists();
                    out.push(`<h3>${applyInlineMarkdown(h3[1])}</h3>`);
                    continue;
                }

                const h2 = trimmed.match(/^##\s+(.*)$/);
                if (h2) {
                    flushParagraph();
                    closeLists();
                    out.push(`<h2>${applyInlineMarkdown(h2[1])}</h2>`);
                    continue;
                }

                const h1 = trimmed.match(/^#\s+(.*)$/);
                if (h1) {
                    flushParagraph();
                    closeLists();
                    out.push(`<h2>${applyInlineMarkdown(h1[1])}</h2>`);
                    continue;
                }

                const ulMatch = trimmed.match(/^[-*]\s+(.*)$/);
                if (ulMatch) {
                    flushParagraph();
                    if (inOl) {
                        out.push('</ol>');
                        inOl = false;
                    }
                    if (!inUl) {
                        out.push('<ul>');
                        inUl = true;
                    }
                    out.push(`<li>${applyInlineMarkdown(ulMatch[1])}</li>`);
                    continue;
                }

                const olMatch = trimmed.match(/^\d+\.\s+(.*)$/);
                if (olMatch) {
                    flushParagraph();
                    if (inUl) {
                        out.push('</ul>');
                        inUl = false;
                    }
                    if (!inOl) {
                        out.push('<ol>');
                        inOl = true;
                    }
                    out.push(`<li>${applyInlineMarkdown(olMatch[1])}</li>`);
                    continue;
                }

                paragraph.push(trimmed);
            }

            flushParagraph();
            closeLists();
            return out.join('\n');
        }

        function inferLanguage(raw, lang) {
            const declared = String(lang || '').toLowerCase();
            if (declared) return declared;
            const text = String(raw || '');
            if (/^\s*#include\s+<|\bstd::\b|\bint\s+main\s*\(/m.test(text)) return 'cpp';
            if (/^\s*from\s+\w+\s+import\s+|^\s*def\s+\w+\s*\(|^\s*class\s+\w+\s*\(|\bself\b/m.test(text)) return 'python';
            if (/^\s*<\/?[a-z][\s\S]*>/mi.test(text)) return 'html';
            if (/\b(const|let|var|function|=>|import\s+.+\s+from)\b/m.test(text)) return 'javascript';
            return 'plain';
        }

        function tokenizeCode(raw, lang) {
            const language = inferLanguage(raw, lang);
            const pyKeywords = new Set([
                'and', 'as', 'assert', 'async', 'await', 'break', 'class', 'continue', 'def', 'del', 'elif',
                'else', 'except', 'False', 'finally', 'for', 'from', 'global', 'if', 'import', 'in', 'is',
                'lambda', 'None', 'nonlocal', 'not', 'or', 'pass', 'raise', 'return', 'True', 'try', 'while',
                'with', 'yield', 'match', 'case'
            ]);
            const jsKeywords = new Set([
                'break', 'case', 'catch', 'class', 'const', 'continue', 'debugger', 'default', 'delete', 'do',
                'else', 'export', 'extends', 'finally', 'for', 'function', 'if', 'import', 'in', 'instanceof',
                'let', 'new', 'return', 'super', 'switch', 'this', 'throw', 'try', 'typeof', 'var', 'void',
                'while', 'with', 'yield', 'async', 'await', 'true', 'false', 'null', 'undefined'
            ]);

            const tokens = [];
            const len = raw.length;
            let i = 0;

            function push(type, text) {
                if (!text) return;
                tokens.push({ type, text });
            }

            while (i < len) {
                const ch = raw[i];
                const next = raw[i + 1] || '';

                if (language.includes('python') && ch === '#') {
                    let j = i + 1;
                    while (j < len && raw[j] !== '\n') j += 1;
                    push('tok-comment', raw.slice(i, j));
                    i = j;
                    continue;
                }
                if ((language.includes('js') || language.includes('ts') || language.includes('json') || language.includes('css') || language.includes('html')) && ch === '/' && next === '/') {
                    let j = i + 2;
                    while (j < len && raw[j] !== '\n') j += 1;
                    push('tok-comment', raw.slice(i, j));
                    i = j;
                    continue;
                }
                if ((language.includes('js') || language.includes('ts') || language.includes('css') || language.includes('html')) && ch === '/' && next === '*') {
                    let j = i + 2;
                    while (j < len - 1 && !(raw[j] === '*' && raw[j + 1] === '/')) j += 1;
                    j = Math.min(len, j + 2);
                    push('tok-comment', raw.slice(i, j));
                    i = j;
                    continue;
                }

                if (ch === '"' || ch === '\'' || ch === '`') {
                    const q = ch;
                    let j = i + 1;
                    while (j < len) {
                        if (raw[j] === '\\') {
                            j += 2;
                            continue;
                        }
                        if (raw[j] === q) {
                            j += 1;
                            break;
                        }
                        j += 1;
                    }
                    push('tok-string', raw.slice(i, j));
                    i = j;
                    continue;
                }

                if (/\d/.test(ch)) {
                    let j = i + 1;
                    while (j < len && /[\d._]/.test(raw[j])) j += 1;
                    push('tok-number', raw.slice(i, j));
                    i = j;
                    continue;
                }

                if (/[A-Za-z_]/.test(ch)) {
                    let j = i + 1;
                    while (j < len && /[A-Za-z0-9_]/.test(raw[j])) j += 1;
                    const word = raw.slice(i, j);
                    const kw = language.includes('python') ? pyKeywords : jsKeywords;
                    const nextSlice = raw.slice(j, j + 3);
                    const prev = raw[i - 1] || '';

                    if (word.startsWith('@')) {
                        push('tok-decorator', word);
                        i = j;
                        continue;
                    }
                    if (kw.has(word)) {
                        push('tok-keyword', word);
                    } else if (/[A-Z]/.test(word[0])) {
                        push('tok-type', word);
                    } else if (/^\s*\(/.test(nextSlice) && prev !== '.') {
                        push('tok-function', word);
                    } else {
                        push('tok-identifier', word);
                    }
                    i = j;
                    continue;
                }

                if (/[=+\-*/%<>!&|^~?:.,;]/.test(ch)) {
                    push('tok-operator', ch);
                    i += 1;
                    continue;
                }

                push('', ch);
                i += 1;
            }

            return tokens;
        }

        function renderTokenWithBrackets(text, tokenClass, stack, openToClose, closeToOpen) {
            let html = '';
            let segment = '';

            function flushSegment() {
                if (!segment) return;
                if (tokenClass) {
                    html += `<span class="${tokenClass}">${escapeHtml(segment)}</span>`;
                } else {
                    html += escapeHtml(segment);
                }
                segment = '';
            }

            for (const ch of text) {
                if (openToClose[ch]) {
                    flushSegment();
                    const depth = stack.length % 8;
                    const type = openToClose[ch].type;
                    const classes = ['bracket', `bracket-depth-${depth}`, `bracket-type-${type}`];
                    if (tokenClass) classes.unshift(tokenClass);
                    html += `<span class="${classes.join(' ')}">${escapeHtml(ch)}</span>`;
                    stack.push({ expectedClose: openToClose[ch].close, depth, type });
                    continue;
                }

                if (closeToOpen[ch]) {
                    flushSegment();
                    const last = stack[stack.length - 1];
                    if (last && last.expectedClose === ch) {
                        const classes = ['bracket', `bracket-depth-${last.depth}`, `bracket-type-${last.type}`];
                        if (tokenClass) classes.unshift(tokenClass);
                        html += `<span class="${classes.join(' ')}">${escapeHtml(ch)}</span>`;
                        stack.pop();
                    } else {
                        const classes = ['bracket', 'bracket-mismatch'];
                        if (tokenClass) classes.unshift(tokenClass);
                        html += `<span class="${classes.join(' ')}">${escapeHtml(ch)}</span>`;
                    }
                    continue;
                }

                segment += ch;
            }

            flushSegment();
            return html;
        }

        function colorizeBracketPairsInCode(container) {
            const blocks = container.querySelectorAll('code.code-view');
            const openToClose = {
                '(': { close: ')', type: 'round' },
                '[': { close: ']', type: 'square' },
                '{': { close: '}', type: 'curly' },
                '<': { close: '>', type: 'angle' },
            };
            const closeToOpen = { ')': '(', ']': '[', '}': '{', '>': '<' };

            blocks.forEach((block) => {
                if (block.dataset.bracketsColored === '1') return;
                const raw = block.textContent || '';
                const lang = Array.from(block.classList)
                    .find((c) => c.startsWith('language-'))
                    ?.slice('language-'.length) || '';
                const tokens = tokenizeCode(raw, lang);
                const stack = [];
                let html = '';

                for (const token of tokens) {
                    html += renderTokenWithBrackets(token.text, token.type, stack, openToClose, closeToOpen);
                }

                block.innerHTML = html;
                block.dataset.bracketsColored = '1';
            });
        }

        function enhanceModalContent() {
            const body = document.getElementById('modal-body');
            if (!body) return;
            colorizeBracketPairsInCode(body);
        }

        function readTextFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(String(reader.result || ''));
                reader.onerror = () => reject(new Error('No se pudo leer el archivo.'));
                reader.readAsText(file, 'utf-8');
            });
        }

        async function loadFileToTextarea(fileInputId, textareaId, infoId) {
            const input = document.getElementById(fileInputId);
            const textarea = document.getElementById(textareaId);
            const info = infoId ? document.getElementById(infoId) : null;
            if (!input || !textarea || !input.files || input.files.length === 0) return false;
            const file = input.files[0];
            try {
                const content = await readTextFile(file);
                textarea.value = content;
                if (info) info.textContent = `Archivo cargado: ${file.name}`;
                return true;
            } catch (_err) {
                showNotification('Error leyendo el archivo.');
                return false;
            }
        }

        function detectPrettierParser(fileName, content) {
            const name = String(fileName || '').toLowerCase();
            if (name.endsWith('.md') || name.endsWith('.markdown') || name.endsWith('.mdx') || name.endsWith('.txt')) return 'markdown';
            if (name.endsWith('.json')) return 'json';
            if (name.endsWith('.js') || name.endsWith('.mjs') || name.endsWith('.cjs')) return 'babel';
            if (name.endsWith('.ts') || name.endsWith('.tsx')) return 'typescript';
            if (name.endsWith('.css') || name.endsWith('.scss') || name.endsWith('.less')) return 'css';
            if (name.endsWith('.html') || name.endsWith('.htm')) return 'html';
            if (name.endsWith('.yaml') || name.endsWith('.yml')) return 'yaml';
            if (/^\s*[\[{]/.test(content || '')) return 'json';
            return 'markdown';
        }

        function getPrettierPlugins() {
            const candidates = [
                window.prettierPlugins?.babel,
                window.prettierPlugins?.estree,
                window.prettierPlugins?.html,
                window.prettierPlugins?.markdown,
                window.prettierPlugins?.postcss,
                window.prettierPlugins?.typescript,
                window.prettierPlugins?.yaml,
            ];
            return candidates.filter(Boolean);
        }

        async function formatWithPrettierForReader(fileName, content) {
            if (!readerSettings.prettierOnRead) return content;
            if (!window.prettier || typeof window.prettier.format !== 'function') return content;

            const parser = detectPrettierParser(fileName, content);
            const plugins = getPrettierPlugins();
            if (plugins.length === 0) return content;

            try {
                const formatted = await window.prettier.format(String(content || ''), {
                    parser,
                    plugins,
                    printWidth: 100,
                    tabWidth: 2,
                    useTabs: false,
                    proseWrap: 'preserve',
                });
                return typeof formatted === 'string' ? formatted : content;
            } catch (_err) {
                return content;
            }
        }

        function saveAll() {
            localStorage.setItem(STORAGE_KEYS.state, JSON.stringify(estado));
            localStorage.setItem(STORAGE_KEYS.classes, JSON.stringify(classRecords));
            localStorage.setItem(STORAGE_KEYS.extras, JSON.stringify(extraRecords));
            localStorage.setItem(STORAGE_KEYS.history, buildHistoryText());
        }

        function loadAll() {
            try {
                const storedState = localStorage.getItem(STORAGE_KEYS.state);
                const storedClasses = localStorage.getItem(STORAGE_KEYS.classes);
                const storedExtras = localStorage.getItem(STORAGE_KEYS.extras);
                const storedReaderSettings = localStorage.getItem(STORAGE_KEYS.readerSettings);

                if (storedState) estado = { ...estado, ...JSON.parse(storedState) };
                if (storedClasses) classRecords = JSON.parse(storedClasses) || [];
                if (storedExtras) extraRecords = JSON.parse(storedExtras) || [];
                if (storedReaderSettings) {
                    readerSettings = { ...readerSettings, ...JSON.parse(storedReaderSettings) };
                }
            } catch (_err) {
                classRecords = [];
                extraRecords = [];
            }
        }

        function saveReaderSettings() {
            localStorage.setItem(STORAGE_KEYS.readerSettings, JSON.stringify(readerSettings));
        }

        function refreshUI() {
            document.getElementById('hito-nombre').textContent = estado.hitoActual;
            document.getElementById('hito-dia').textContent = estado.dia;
            const statusEl = document.getElementById('hito-status');
            statusEl.textContent = estado.estado === 'completado' ? 'Completado' : 'Pendiente';
            statusEl.className = `hito-status ${estado.estado === 'completado' ? 'completado' : 'pendiente'}`;

            const tipos = ['python', 'math', 'trading', 'architect'];
            document.querySelectorAll('.progreso-fill').forEach((el, i) => {
                el.style.width = `${estado.progreso[tipos[i]] || 0}%`;
            });
            document.querySelectorAll('.progreso-pct').forEach((el, i) => {
                el.textContent = `${estado.progreso[tipos[i]] || 0}%`;
            });
        }

        function buildHistoryText() {
            const classLines = classRecords.map((r) =>
                `${r.date} | ${r.hito} | CLASS | ${r.fileName} | ${r.persistMode || 'memory'}`
            );
            const extraLines = extraRecords.map((r) =>
                `${r.date} | ${r.hito} | ${r.category} | ${r.fileName}`
            );
            return [...classLines, ...extraLines].sort().join('\n');
        }

        function downloadMarkdown(fileName, content) {
            const blob = new Blob([content.endsWith('\n') ? content : `${content}\n`], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function writeMarkdownToFs(fileName, content, relativeDir) {
            if (!fsRootHandle) return false;
            let target = fsRootHandle;
            const parts = relativeDir.split('/').filter(Boolean);
            for (const part of parts) {
                target = await target.getDirectoryHandle(part, { create: true });
            }
            const fileHandle = await target.getFileHandle(fileName, { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(content.endsWith('\n') ? content : `${content}\n`);
            await writable.close();
            return true;
        }

        async function persistMarkdownFile(fileName, content, relativeDir) {
            try {
                const saved = await writeMarkdownToFs(fileName, content, relativeDir);
                if (saved) {
                    return { mode: 'filesystem', location: `${relativeDir}/${fileName}` };
                }
            } catch (_err) {
                // fallback a descarga
            }
            downloadMarkdown(fileName, content);
            return { mode: 'download', location: fileName };
        }

        async function configurarCarpetaMD() {
            if (!window.showDirectoryPicker) {
                showNotification('Tu navegador no soporta carpeta persistente. Se usará descarga .md.');
                return;
            }
            try {
                fsRootHandle = await window.showDirectoryPicker();
                showNotification('Carpeta .md configurada para esta sesión.');
                updateFsStatus();
            } catch (_err) {
                showNotification('Selección de carpeta cancelada.');
            }
        }

        function updateFsStatus() {
            const el = document.getElementById('fs-status');
            if (!el) return;
            if (fsRootHandle) {
                el.textContent = 'Persistencia .md: carpeta local activa (esta sesión).';
                return;
            }
            el.textContent = 'Persistencia .md: modo descarga automática (.md).';
        }

        function showHelp() {
            const helpContent = `
                <h3>CÓMO USAR ESTA INTERFAZ</h3>
                <ol>
                    <li><strong>Crear clase</strong> -> genera prompt para tu LLM.</li>
                    <li><strong>Incluir .MD</strong> -> guarda clase y persiste markdown.</li>
                    <li><strong>Añadir extra</strong> -> guarda extra en una categoría:
                        <code>PYTHON_TUTOR</code>, <code>MATH_TUTOR</code>, <code>TRADING_EXPERT</code>, <code>ARCHITECT</code>.
                    </li>
                    <li><strong>Archivos</strong> -> buscar por categoría y texto, ver y eliminar contenido.</li>
                </ol>
                <h3>PERSISTENCIA .MD</h3>
                <p>La app intenta guardar en carpeta local si la configuras. Si no, descarga archivos <code>.md</code> automáticamente.</p>
            `;
            showModal('AYUDA', helpContent);
        }

        function crearClase() {
            showModal('CREAR CLASE - Copia este prompt', `
                <p>Copia el siguiente prompt y pégalo en tu LLM avanzado:</p>
                <pre>${escapeHtml(promptCrearClase)}</pre>
                <p style="margin-top: 15px;">Después de generar, usa <strong>[INCLUIR .MD]</strong> para guardar el resultado.</p>
            `);
        }

        function incluirMD() {
            showModal('INCLUIR ARCHIVO .MD', `
                <p>Pega el contenido generado por el LLM:</p>
                <div class="textarea-container">
                    <label class="textarea-label">O subir archivo desde tu PC (.md/.txt)</label>
                    <input type="file" id="md-file" accept=".md,.txt,.markdown,text/markdown,text/plain"
                           class="textarea-input" style="min-height:auto;" onchange="loadFileToTextarea('md-file','md-content','md-file-info')">
                    <div id="md-file-info" class="file-status" style="margin-top:6px;"></div>
                </div>
                <div class="textarea-container">
                    <textarea class="textarea-input" id="md-content" placeholder="Pega aquí el contenido del archivo clase.md..."></textarea>
                </div>
                <button class="accion-btn primary" onclick="guardarMD()">GUARDAR</button>
            `);
        }

        async function guardarMD() {
            const textarea = document.getElementById('md-content');
            let content = textarea.value;
            if (!content.trim()) {
                await loadFileToTextarea('md-file', 'md-content', 'md-file-info');
                content = textarea.value;
            }
            if (!content.trim()) {
                showNotification('El contenido está vacío.');
                return;
            }

            const date = nowDate();
            const safeHito = slugify(estado.hitoActual);
            const fileName = `clase_${date}_${safeHito}.md`;
            const relativeDir = `learning/estudios/${date}_${safeHito}`;
            const persisted = await persistMarkdownFile(fileName, content, relativeDir);
            const record = {
                id: makeId('class'),
                type: 'CLASS_CONTENT',
                hito: estado.hitoActual,
                date,
                createdAt: nowIso(),
                fileName,
                content,
                persistMode: persisted.mode,
                persistLocation: persisted.location,
            };

            classRecords.push(record);
            saveAll();
            closeModal();
            showNotification(`Clase guardada (${persisted.mode}).`);
        }

        function getLatestClassForCurrentHito() {
            const candidates = classRecords
                .filter((r) => r.hito === estado.hitoActual)
                .sort((a, b) => b.createdAt.localeCompare(a.createdAt));
            if (candidates.length > 0) return candidates[0];
            const any = classRecords.sort((a, b) => b.createdAt.localeCompare(a.createdAt));
            return any[0] || null;
        }

        async function leerClase() {
            const record = getLatestClassForCurrentHito();
            if (!record) {
                showNotification('No hay clase guardada. Usa CREAR CLASE e INCLUIR .MD.');
                return;
            }
            const formatted = await formatWithPrettierForReader(record.fileName, record.content);
            const html = markdownToHtml(formatted);
            showModal(`CLASE: ${record.hito}`, `<div class="estudio-content">${html}</div>`);
        }

        function anadirExtra() {
            const options = EXTRA_CATEGORIES.map((c) => `<option value="${c}">${c}</option>`).join('');
            showModal('AÑADIR MATERIAL EXTRA', `
                <p>Guarda contenido adicional por categoría:</p>
                <div class="textarea-container">
                    <label class="textarea-label">Categoría</label>
                    <select id="extra-category" class="textarea-input" style="min-height:auto;">
                        ${options}
                    </select>
                </div>
                <div class="textarea-container">
                    <label class="textarea-label">O subir archivo desde tu PC (.md/.txt)</label>
                    <input type="file" id="extra-file" accept=".md,.txt,.markdown,text/markdown,text/plain"
                           class="textarea-input" style="min-height:auto;" onchange="loadFileToTextarea('extra-file','extra-content','extra-file-info')">
                    <div id="extra-file-info" class="file-status" style="margin-top:6px;"></div>
                </div>
                <div class="textarea-container">
                    <label class="textarea-label">Contenido extra</label>
                    <textarea class="textarea-input" id="extra-content" placeholder="Escribe lo que aprendiste adicional..."></textarea>
                </div>
                <button class="accion-btn primary" onclick="guardarExtra()">GUARDAR EXTRA</button>
            `);
        }

        async function guardarExtra() {
            const category = document.getElementById('extra-category').value;
            const textarea = document.getElementById('extra-content');
            let content = textarea.value;
            if (!content.trim()) {
                await loadFileToTextarea('extra-file', 'extra-content', 'extra-file-info');
                content = textarea.value;
            }
            if (!content.trim()) {
                showNotification('El contenido está vacío.');
                return;
            }
            if (!EXTRA_CATEGORIES.includes(category)) {
                showNotification('Categoría inválida.');
                return;
            }

            const date = nowDate();
            const safeHito = slugify(estado.hitoActual);
            const fileName = `extra_${date}_${safeHito}_${category.toLowerCase()}.md`;
            const relativeDir = `learning/estudios/${date}_${safeHito}/extras`;
            const persisted = await persistMarkdownFile(fileName, content, relativeDir);
            const record = {
                id: makeId('extra'),
                type: 'EXTRA_CONTENT',
                hito: estado.hitoActual,
                date,
                createdAt: nowIso(),
                category,
                fileName,
                content,
                persistMode: persisted.mode,
                persistLocation: persisted.location,
            };

            extraRecords.push(record);
            saveAll();
            closeModal();
            showNotification(`Extra ${category} guardado (${persisted.mode}).`);
        }

        function completarHito() {
            showModal('COMPLETAR HITO', `
                <p>¿Confirmas que completaste el hito <strong>${escapeHtml(estado.hitoActual)}</strong>?</p>
                <ol>
                    <li>Se actualiza el progreso local.</li>
                    <li>Puedes continuar al siguiente hito.</li>
                </ol>
                <button class="accion-btn primary" onclick="confirmarCompletar()">CONFIRMAR</button>
            `);
        }

        function confirmarCompletar() {
            estado.estado = 'completado';
            estado.progreso.python = Math.min(100, estado.progreso.python + 5);
            estado.progreso.math = Math.min(100, estado.progreso.math + 5);
            estado.progreso.trading = Math.min(100, estado.progreso.trading + 5);
            estado.progreso.architect = Math.min(100, estado.progreso.architect + 5);

            const idx = HITOS.indexOf(estado.hitoActual);
            if (idx >= 0 && idx < HITOS.length - 1) {
                estado.hitoActual = HITOS[idx + 1];
                estado.dia += 1;
                estado.estado = 'pendiente';
            }

            saveAll();
            refreshUI();
            closeModal();
            showNotification('Hito actualizado.');
        }

        function verHistorial() {
            const history = localStorage.getItem(STORAGE_KEYS.history) || 'Aún no hay entradas en el historial.';
            showModal('HISTORIAL DE APRENDIZAJE', `<pre>${escapeHtml(history)}</pre>`);
        }

        function allRecords() {
            const classes = classRecords.map((r) => ({ ...r, viewCategory: 'CLASS_CONTENT', badgeClass: 'class', typeKey: 'class' }));
            const extras = extraRecords.map((r) => ({
                ...r,
                viewCategory: r.category,
                badgeClass: categoryBadge(r.category),
                typeKey: 'extra',
            }));
            return [...classes, ...extras].sort((a, b) => b.createdAt.localeCompare(a.createdAt));
        }

        function categoryBadge(category) {
            if (category === 'PYTHON_TUTOR') return 'python';
            if (category === 'MATH_TUTOR') return 'math';
            if (category === 'TRADING_EXPERT') return 'trading';
            if (category === 'ARCHITECT') return 'architect';
            return 'class';
        }

        function gestionarArchivos() {
            showModal('GESTIONAR ARCHIVOS', `
                <div class="file-tools">
                    <button class="accion-btn primary full" onclick="configurarCarpetaMD()">CONFIGURAR CARPETA .MD (opcional)</button>
                    <label class="file-status full" style="display:flex; gap:8px; align-items:center;">
                        <input type="checkbox" id="toggle-prettier-read" onchange="togglePrettierRead(this.checked)">
                        Aplicar Prettier Formatter al leer archivos
                    </label>
                    <select id="file-category-filter" onchange="renderFileList()">
                        <option value="ALL">TODAS</option>
                        <option value="CLASS_CONTENT">CLASS_CONTENT</option>
                        ${EXTRA_CATEGORIES.map((c) => `<option value="${c}">${c}</option>`).join('')}
                    </select>
                    <input id="file-search-input" type="text" placeholder="Buscar por nombre, hito o contenido..." oninput="renderFileList()">
                    <div id="fs-status" class="file-status full"></div>
                </div>
                <div id="file-list" class="file-list"></div>
            `);
            updateFsStatus();
            const toggle = document.getElementById('toggle-prettier-read');
            if (toggle) toggle.checked = !!readerSettings.prettierOnRead;
            renderFileList();
        }

        function togglePrettierRead(checked) {
            readerSettings.prettierOnRead = !!checked;
            saveReaderSettings();
            showNotification(readerSettings.prettierOnRead
                ? 'Prettier activado para el lector.'
                : 'Prettier desactivado para el lector.');
        }

        function renderFileList() {
            const container = document.getElementById('file-list');
            if (!container) return;

            const category = document.getElementById('file-category-filter')?.value || 'ALL';
            const q = (document.getElementById('file-search-input')?.value || '').toLowerCase().trim();
            let records = allRecords();

            if (category !== 'ALL') {
                records = records.filter((r) => r.viewCategory === category);
            }
            if (q) {
                records = records.filter((r) => {
                    const haystack = `${r.fileName} ${r.hito} ${r.viewCategory} ${r.content}`.toLowerCase();
                    return haystack.includes(q);
                });
            }

            if (records.length === 0) {
                container.innerHTML = '<div class="file-item">No hay archivos para ese filtro.</div>';
                return;
            }

            container.innerHTML = records.map((r) => {
                const preview = escapeHtml(r.content.slice(0, 180)).replace(/\n/g, ' ');
                return `
                    <div class="file-item">
                        <div class="file-item-header">
                            <span class="file-badge ${r.badgeClass}">${r.viewCategory}</span>
                            <span class="file-name">${escapeHtml(r.fileName)}</span>
                        </div>
                        <div class="file-meta">${escapeHtml(r.date)} | Hito: ${escapeHtml(r.hito)} | Persistencia: ${escapeHtml(r.persistMode || 'memory')}</div>
                        <div class="file-preview">${preview}${r.content.length > 180 ? '...' : ''}</div>
                        <div class="file-actions">
                            <button class="accion-btn small" onclick="verArchivo('${r.id}', '${r.typeKey}')">VER</button>
                            <button class="accion-btn danger small" onclick="eliminarArchivo('${r.id}', '${r.typeKey}')">ELIMINAR</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function findRecord(id, type) {
            if (type === 'class') {
                return classRecords.find((r) => r.id === id) || null;
            }
            return extraRecords.find((r) => r.id === id) || null;
        }

        async function verArchivo(id, type) {
            const record = findRecord(id, type);
            if (!record) {
                showNotification('Archivo no encontrado.');
                return;
            }
            const formatted = await formatWithPrettierForReader(record.fileName, record.content);
            showModal(`VER ARCHIVO: ${record.fileName}`, `
                <div class="estudio-content">${markdownToHtml(formatted)}</div>
                <div style="margin-top: 12px;">
                    <button class="accion-btn danger" onclick="eliminarArchivo('${record.id}', '${type}')">ELIMINAR ESTE ARCHIVO</button>
                </div>
            `);
        }

        function eliminarArchivo(id, type) {
            const msg = type === 'class'
                ? '¿Eliminar este contenido de clase?'
                : '¿Eliminar este contenido extra específico?';
            if (!confirm(msg)) return;

            if (type === 'class') {
                classRecords = classRecords.filter((r) => r.id !== id);
            } else {
                extraRecords = extraRecords.filter((r) => r.id !== id);
            }
            saveAll();
            if (document.getElementById('file-list')) {
                renderFileList();
            }
            showNotification('Contenido eliminado.');
        }

        function toggleModalFullscreen() {
            const modal = document.getElementById('modal');
            const modalContent = document.querySelector('#modal .modal-content');
            const btn = document.getElementById('modal-fullscreen-btn');
            if (!modalContent) return;
            modalContent.classList.toggle('fullscreen');
            if (modal) {
                modal.classList.toggle('modal-fullscreen', modalContent.classList.contains('fullscreen'));
            }
            if (btn) {
                btn.textContent = modalContent.classList.contains('fullscreen') ? '🗗' : '⛶';
                btn.title = modalContent.classList.contains('fullscreen')
                    ? 'Salir de pantalla completa'
                    : 'Pantalla completa';
            }
        }

        function showModal(title, content) {
            const modal = document.getElementById('modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            modal.classList.add('active');
            modal.classList.remove('modal-fullscreen');
            const modalContent = document.querySelector('#modal .modal-content');
            const btn = document.getElementById('modal-fullscreen-btn');
            if (modalContent) modalContent.classList.remove('fullscreen');
            if (btn) {
                btn.textContent = '⛶';
                btn.title = 'Pantalla completa';
            }
            enhanceModalContent();
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.remove('active');
            modal.classList.remove('modal-fullscreen');
            const modalContent = document.querySelector('#modal .modal-content');
            if (modalContent) modalContent.classList.remove('fullscreen');
        }

        function showNotification(message) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.classList.add('show');
            setTimeout(() => notif.classList.remove('show'), 3000);
        }

        function init() {
            loadAll();
            saveReaderSettings();
            refreshUI();
            saveAll();
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') closeModal();
        });

        init();
    </script>
</body>
</html>
